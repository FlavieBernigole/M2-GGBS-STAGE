---
title: "Pseudotime-SlingShot"
author: "Flavie BERNIGOLE"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# chargement des librairies
library(ggplot2)
library(Seurat)
library(clustree)
library(dplyr)
library(openxlsx)
library(data.table)
library(ggpubr)
library(dittoSeq)
library(scales)
library(RColorBrewer)
library(viridis)
sample <- readRDS("objet_seurat.rds")
```

## Slingshot 

```{r , fig.height=7, fig.width=10, results='asis',echo=F, warning=F, message=F}
library(slingshot)
#Calculate pseudotime and lineages with Slingshot
Idents(sample) <- "RNA_snn_res.0.2"
sce <- slingshot(as.SingleCellExperiment(sample), clusterLabels = "RNA_snn_res.0.2", reducedDim = "UMAP", allow.breaks = FALSE)
# get the lineages:
lnes <- getLineages(reducedDim(sce,"UMAP"), sce$ident)
cat("Lineage detected")
cat("\n")
lnes@metadata$lineages
cell_pal <- function(cell_vars, pal_fun,...) {
  if (is.numeric(cell_vars)) {
    pal <- pal_fun(100, ...)
    return(pal[cut(cell_vars, breaks = 100)])
  } else {
    categories <- sort(unique(cell_vars))
    pal <- setNames(pal_fun(length(categories), ...), categories)
    return(pal[cell_vars])
  }
}

cell_colors_clust <- cell_pal(sample$RNA_snn_res.0.2, hue_pal())

plot(reducedDims(sce)$UMAP, col = cell_colors_clust, pch = 16, cex = 0.5,asp = 1) 
lines(SlingshotDataSet(lnes), lwd = 1, type = 'lineages', col = 'black')


plot(reducedDims(sce)$UMAP, col = cell_colors_clust, pch = 16, cex = 0.5, asp = 1)

# Extraire les courbes pour chaque lignage
lnes <- SlingshotDataSet(sce)
curves <- lnes@curves

# Définir les couleurs des lignages
lineage_colors <- c("#F31559", "#0802A3")

# Tracer chaque lignage avec une couleur différente
for (i in seq_along(curves)) {
    curve <- curves[[i]]
    lines(curve$s[ , 1], curve$s[ , 2], col = lineage_colors[i], lwd = 4)
}

# full plot
pt <- slingPseudotime(sce)
nc <- 2
nms <- colnames(pt)
nr <- ceiling(length(nms)/nc)
pal <- viridis(100, end = 0.95)
par(mfrow = c(nr, 2))
for (i in nms) {
    colors <- pal[cut(pt[,i], breaks = 100)]
    plot(reducedDims(sce)$UMAP, col = colors, pch = 16, cex = 0.5, main = i)
    curve <- curves[[i]]
    lines(curve$s[ , 1], curve$s[ , 2], col = "black", lwd = 2)

}

lgd <- matrix(hcl.colors(50), nrow=1)
rasterImage(lgd, 2,-3,6,-3.5)
text(c(2,6), c(-3.5,-3.5), pos = 1, cex = .7,
     labels = format(range(slingPseudotime(sce), na.rm = TRUE), digits = 3))
text(3, -3, pos = 3, cex = .7, labels = 'Pseudotime')
'''



